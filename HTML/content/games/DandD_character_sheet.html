// Load Character with combat stats
    function loadCharacter() {
        // Create a file input for loading from JSON
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const character = JSON.parse(event.target.result);
                    
                    // Populate the basic fields
                    document.getElementById('characterName').value = character.name || '';
                    document.getElementById('race').value = character.race || 'human';
                    document.getElementById('gender').value = character.gender || 'male';
                    document.getElementById('class').value = character.class || 'fighter';
                    document.getElementById('level').value = character.level || 1;
                    document.getElementById('strength').value = character.strength || 10;
                    document.getElementById('dexterity').value = character.dexterity || 10;
                    document.getElementById('constitution').value = character.constitution || 10;
                    document.getElementById('intelligence').value = character.intelligence || 10;
                    document.getElementById('wisdom').value = character.wisdom || 10;
                    document.getElementById('charisma').value = character.charisma || 10;
                    document.getElementById('hitPoints').value = character.hitPoints || 10;
                    document.getElementById('armorClass').value = character.armorClass || 10;
                    document.getElementById('initiative').value = character.initiative || 0;
                    document.getElementById('equipment').value = character.equipment || '';
                    document.getElementById('characterDescription').value = character.characterDescription || '';
                    
                    // Load weapon type if available
                    if (character.weaponType) {
                        document.getElementById('weaponType').value = character.weaponType;
                    }
                    
                    // If character has an image, load it
                    if (character.imageData) {
                        const container = document.getElementById('characterImageContainer');
                        container.innerHTML = `<img src="${character.imageData}" alt="Character Image">`;
                    }
                    
                    // Update combat stats based on loaded data
                    updateCombatStats();
                    
                    alert('Character loaded successfully! / पात्र सफलतापूर्वक लोड गरियो!');
                } catch (error) {
                    console.error('Error loading character:', error);
                    alert('Failed to load character file! / पात्र फाइल लोड गर्न असफल भयो!');
                }
            };
            
            reader.readAsText(file);
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
    }

    // Initialize keys when page loads and set up the combat stats
    window.onload = function() {
        initializeKeys().catch(error => {
            console.error('Failed to initialize keys:', error);
        });
        
        // Initialize combat stats on page load
        updateCombatStats();
        
        // Add event listeners to all inputs that might affect combat stats
        document.getElementById('strength').addEventListener('change', updateCombatStats);
        document.getElementById('dexterity').addEventListener('change', updateCombatStats);
        document.getElementById('constitution').addEventListener('change', updateCombatStats);
        document.getElementById('level').addEventListener('change', updateCombatStats);
        document.getElementById('weaponType').addEventListener('change', updateCombatStats);
        document.getElementById('armorClass').addEventListener('change', updateCombatStats);
    };
</script>
</body>
</html>    // Image Upload
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const container = document.getElementById('characterImageContainer');
                container.innerHTML = `<img src="${e.target.result}" alt="Character Image">`;
                localStorage.setItem('characterImage', e.target.result);
            };
            reader.readAsDataURL(file);
        }
    }

    // Save Character with combat stats
    function saveCharacter() {
        // Check if character name is provided
        const characterName = document.getElementById('characterName').value.trim();
        if (!characterName) {
            alert('Please enter a character name before saving! / कृपया सेभ गर्नु अघि पात्रको नाम प्रविष्ट गर्नुहोस्!');
            document.getElementById('characterName').focus();
            return;
        }
        
        // Get combat stats from the display
        const attackValue = document.getElementById('attackValue').textContent;
        const defenseValue = document.getElementById('defenseValue').textContent;
        const damageValue = document.getElementById('damageValue').textContent;
        const absorptionValue = document.getElementById('absorptionValue').textContent;
        
        const character = {
            name: document.getElementById('characterName').value,
            race: document.getElementById('race').value,
            gender: document.getElementById('gender').value,
            class: document.getElementById('class').value,
            level: document.getElementById('level').value,
            strength: document.getElementById('strength').value,
            dexterity: document.getElementById('dexterity').value,
            constitution: document.getElementById('constitution').value,
            intelligence: document.getElementById('intelligence').value,
            wisdom: document.getElementById('wisdom').value,
            charisma: document.getElementById('charisma').value,
            hitPoints: document.getElementById('hitPoints').value,
            armorClass: document.getElementById('armorClass').value,
            initiative: document.getElementById('initiative').value,
            equipment: document.getElementById('equipment').value,
            characterDescription: document.getElementById('characterDescription').value,
            // Add combat stats
            weaponType: document.getElementById('weaponType').value,
            attackValue: attackValue,
            defenseValue: defenseValue,
            damageValue: damageValue,
            absorptionValue: absorptionValue
        };

        // Get character image if it exists
        const imageContainer = document.getElementById('characterImageContainer');
        const characterImage = imageContainer.querySelector('img');
        if (characterImage) {
            character.imageData = characterImage.src;
        }

        // Create blob from character data
        const characterBlob = new Blob([JSON.stringify(character, null, 2)], { type: 'application/json' });
        
        // Generate filename using character name or default name
        const filename = character.name ? 
            `${character.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json` : 
            'dnd_character.json';

        // Create download link
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(characterBlob);
        downloadLink.download = filename;
        
        // Trigger download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // Clean up
        URL.revokeObjectURL(downloadLink.href);
        
        alert('Character saved to file! / पात्र फाइलमा सेभ गरियो!');
    }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet - English/Nepali</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash/4.17.21/lodash.min.js"></script>
    <style>
        .character-image {
            width: 200px;
            height: 200px;
            border: 2px dashed #ccc;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .character-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .equipment-section, .description-section {
            resize: vertical;
            min-height: 100px;
            width: 100%;
            font-family: Arial, sans-serif;
            padding: 10px;
        }
        .image-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .generate-btn {
            background-color: #6a5acd;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .field {
            margin-bottom: 10px;
        }
        .label {
            display: block;
            margin-bottom: 5px;
        }
        .nepali {
            color: #666;
            font-style: italic;
        }
        input, select {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
        }
        .ability-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .ability-score {
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            width: 0;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            color: #666;
        }
        .generate-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        /* Combat stats styles */
        .combat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .combat-stat {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .combat-stat h3 {
            margin-top: 0;
            color: #555;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .combat-stat-value {
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
            color: #333;
        }
        .weapon-selector {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>Nepali D&D Character Sheet / डी एंड डी क्यारेक्टर सीट</h1>
    
    <div class="section">
        <h2>Basic Information / आधारभूत जानकारी</h2>
        <div class="field">
            <label class="label">
                Character Name / पात्रको नाम:
                <input type="text" id="characterName">
            </label>
        </div>
        <div class="field">
            <label class="label">
                Race / जाति:
                <select id="race">
                    <option value="yeti">Yeti / यती </option>
                    <option value="kinnaras">Kinnaras / किन्नारस</option>
                    <option value="human">Human / मानव</option>
                    <option value="bon">Bon / बोन</option>
                    <option value="dakinis">Dakinis / डाकिनिस</option>
                </select>
            </label>
        </div>
        <div class="field">
            <label class="label">
                Gender / लिङ्ग:
                <select id="gender">
                    <option value="male">Male / पुरुष</option>
                    <option value="female">Female / महिला</option>
                </select>
            </label>
        </div>
        <div class="field">
            <label class="label">
                Class / वर्ग:
                <select id="class">
                    <option value="gurkhali">Gurkhali / गुरुखली</option>
                    <option value="gandharva">Gandharva - gandharva / गान्ध्रवा</option>
                    <option value="druid">Bon - Po / बोन-पो</option>
                    <option value="fighter">Fighter / फाइटर</option>
                    <option value="monk">Monk / भिक्षु</option>
                    <option value="paladin">Paladin / प्यालाडिन</option>
                    <option value="ranger">Ranger / रेन्जर</option>
                    <option value="rogue">Rogue / रोग</option>
                    <option value="dhami">Dhami - Mediums possessed by deities, gaining their powers temporarily / धामी</option>
                    <option value="jakhris">Jakhris - shamans who use ritual objects, herbs, and spirit communication / जख्रिस</option>
                    <option value="wizard">Wizard / विज़र्ड</option>
                </select>
            </label>
        </div>
        <div class="field">
            <label class="label">
                Level / स्तर:
                <input type="number" id="level" min="1" max="20" value="1" onchange="updateCombatStats()">
            </label>
        </div>
    </div>

    <div class="section">
        <h2>Ability Scores / क्षमता स्कोर</h2>
        <div class="ability-scores">
            <div class="ability-score">
                <label class="label">
                    Strength / बल
                    <input type="number" id="strength" min="1" max="20" value="10" onchange="updateCombatStats()">
                </label>
            </div>
            <div class="ability-score">
                <label class="label">
                    Dexterity / चतुर्य
                    <input type="number" id="dexterity" min="1" max="20" value="10" onchange="updateCombatStats()">
                </label>
            </div>
            <div class="ability-score">
                <label class="label">
                    Constitution / संविधान
                    <input type="number" id="constitution" min="1" max="20" value="10" onchange="updateCombatStats()">
                </label>
            </div>
            <div class="ability-score">
                <label class="label">
                    Intelligence / बुद्धि
                    <input type="number" id="intelligence" min="1" max="20" value="10" onchange="updateCombatStats()">
                </label>
            </div>
            <div class="ability-score">
                <label class="label">
                    Wisdom / ज्ञान
                    <input type="number" id="wisdom" min="1" max="20" value="10" onchange="updateCombatStats()">
                </label>
            </div>
            <div class="ability-score">
                <label class="label">
                    Charisma / करिश्मा
                    <input type="number" id="charisma" min="1" max="20" value="10" onchange="updateCombatStats()">
                </label>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Combat Stats / युद्ध तथ्यांक</h2>
        <div class="field">
            <label class="label">
                Hit Points / हिट पोइन्ट्स:
                <input type="number" id="hitPoints" min="1" value="10">
            </label>
        </div>
        <div class="field">
            <label class="label">
                Armor Class / कवच वर्ग:
                <input type="number" id="armorClass" min="1" value="10">
            </label>
        </div>
        <div class="field">
            <label class="label">
                Initiative / पहल:
                <input type="number" id="initiative" value="0">
            </label>
        </div>
        <div class="field weapon-selector">
            <label class="label">
                Weapon / हतियार:
                <select id="weaponType" onchange="updateCombatStats()">
                    <option value="unarmed">Unarmed / निहत्था</option>
                    <option value="dagger">Dagger / छुरा</option>
                    <option value="shortsword">Short Sword / छोटो तरवार</option>
                    <option value="longsword">Long Sword / लामो तरवार</option>
                    <option value="kukri">Kukri / खुकुरी</option>
                    <option value="bow">Bow / धनुष</option>
                    <option value="spear">Spear / भाला</option>
                    <option value="staff">Staff / लाठी</option>
                    <option value="warhammer">Warhammer / युद्ध हथौडा</option>
                    <option value="maul">Maul / विशाल गदा</option>
                </select>
            </label>
        </div>
        
        <h3>Combat Statistics / युद्ध आँकडा</h3>
        <div class="combat-grid">
            <div class="combat-stat">
                <h3>Attack / आक्रमण</h3>
                <div id="attackValue" class="combat-stat-value">+0 + 2d6</div>
            </div>
            <div class="combat-stat">
                <h3>Defense / बचाव</h3>
                <div id="defenseValue" class="combat-stat-value">+0 + 2d6</div>
            </div>
            <div class="combat-stat">
                <h3>Damage / क्षति</h3>
                <div id="damageValue" class="combat-stat-value">0</div>
            </div>
            <div class="combat-stat">
                <h3>Damage Absorption / क्षति अवशोषण</h3>
                <div id="absorptionValue" class="combat-stat-value">0</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Character Description / पात्र विवरण</h2>
        <textarea id="characterDescription" class="description-section" placeholder="Describe your character's appearance, personality, and background / तपाईंको पात्रको रूप, व्यक्तित्व र पृष्ठभूमि वर्णन गर्नुहोस्"></textarea>
    </div>

    <div class="section">
        <h2>Character Image / पात्र चित्र</h2>
        <div class="image-buttons">
            <button onclick="generateAIImage()" class="generate-btn">Generate AI Image / एआई चित्र सिर्जना गर्नुहोस्</button>
        </div>
        <div class="character-image" id="characterImageContainer" onclick="document.getElementById('imageInput').click()">
            <input type="file" id="imageInput" accept="image/*" style="display: none" onchange="handleImageUpload(event)">
            <span id="imagePrompt">Click to add character image / चित्र थप्न क्लिक गर्नुहोस्</span>
        </div>
    </div>

    <div class="section">
        <h2>Equipment / उपकरण</h2>
        <textarea id="equipment" class="equipment-section" placeholder="List your equipment here / तपाईंको उपकरणहरू यहाँ सूचीबद्ध गर्नुहोस्"></textarea>
    </div>

    <div class="buttons">
        <button onclick="generateRandomCharacter()" class="generate-btn">Generate Random Character / यादृच्छिक पात्र सिर्जना गर्नुहोस्</button>
        <button onclick="saveCharacter()">Save Character / पात्र सेभ गर्नुहोस्</button>
        <button onclick="loadCharacter()">Load Character / पात्र लोड गर्नुहोस्</button>
    </div>

<script>
    // Global variables for API keys
    let HUGGING_FACE_API_KEY = null;
    let STABILITY_API_KEY = null;
    let keysInitialized = false;

    // Helper functions
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function rollAbilityScore() {
        const rolls = Array.from({length: 4}, () => getRandomInt(1, 6));
        rolls.sort((a, b) => b - a);
        return rolls.slice(0, 3).reduce((sum, roll) => sum + roll, 0);
    }

    function getModifier(score) {
        return Math.floor((score - 10) / 2);
    }

    function calculateHP(characterClass, level, constitutionMod) {
        const hitDice = {
            'gurkhali': 12,
            'fighter': 10,
            'paladin': 10,
            'ranger': 10,
            'monk': 8,
            'rogue': 8,
            'gandharva': 8,
            'cleric': 8,
            'druid': 8,
            'warlock': 8,
            'dhami': 6,
            'wizard': 6
        };
        const baseHP = hitDice[characterClass] || 8; // Default to 8 if class not found
        return baseHP + constitutionMod + 
               ((level - 1) * (Math.floor(baseHP/2) + 1 + constitutionMod));
    }

    function calculateAC(characterClass, dexterityMod) {
        return 10 + dexterityMod;
    }

    // Weapon damage dice definitions
    const weaponDamage = {
        'unarmed': '1d3',
        'dagger': '1d4',
        'shortsword': '1d6',
        'longsword': '1d8',
        'kukri': '1d6',
        'bow': '1d8',
        'spear': '1d6',
        'staff': '1d6',
        'warhammer': '1d8 + 1d4',
        'maul': '1d10 + 1d6'
    };

    // Proficiency bonus based on level
    function getProficiencyBonus(level) {
        if (level <= 4) return 2;
        if (level <= 8) return 3;
        if (level <= 12) return 4;
        if (level <= 16) return 5;
        return 6;
    }

    // Function to update combat stats
    function updateCombatStats() {
        const strengthScore = parseInt(document.getElementById('strength').value) || 10;
        const dexterityScore = parseInt(document.getElementById('dexterity').value) || 10;
        const constitutionScore = parseInt(document.getElementById('constitution').value) || 10;
        const level = parseInt(document.getElementById('level').value) || 1;
        
        const strengthMod = getModifier(strengthScore);
        const dexterityMod = getModifier(dexterityScore);
        const constitutionMod = getModifier(constitutionScore);
        
        const proficiencyBonus = getProficiencyBonus(level);
        
        // Get selected weapon
        const weaponType = document.getElementById('weaponType').value;
        
        // Calculate attack bonus
        // For melee weapons, use strength; for ranged weapons (bow), use dexterity
        const isRanged = weaponType === 'bow';
        const attackMod = isRanged ? dexterityMod : strengthMod;
        const attackBonus = attackMod + proficiencyBonus;
        
        // Calculate AC and Defense value
        const totalAC = parseInt(document.getElementById('armorClass').value) || 10;
        
        // Get weapon damage dice
        const damageFormula = weaponDamage[weaponType] || '1d3';
        const damageAddition = isRanged ? dexterityMod : strengthMod;
        
        // Calculate damage absorption from constitution
        const damageAbsorption = constitutionMod;
        
        // Update the displayed values
        document.getElementById('attackValue').textContent = `+${attackBonus} + 2d6`;
        document.getElementById('defenseValue').textContent = `+${totalAC} + 2d6`;
        document.getElementById('damageValue').textContent = 
            `${damageFormula} + ${damageAddition > 0 ? '+' + damageAddition : damageAddition}`;
        document.getElementById('absorptionValue').textContent = damageAbsorption;
    }

    // API key initialization
    async function initializeKeys() {
        if (keysInitialized) return;
        
        try {
            const response = await fetch('https://zuqaonnjhyobeljlum4m6gclae0gdxsp.lambda-url.us-west-2.on.aws/', {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const keys = await response.json();
            if (!keys.huggingFaceKey || !keys.stabilityKey) {
                throw new Error('Invalid API key data received');
            }
            
            HUGGING_FACE_API_KEY = keys.huggingFaceKey;
            STABILITY_API_KEY = keys.stabilityKey;
            keysInitialized = true;
            console.log('API keys initialized successfully');
        } catch (error) {
            console.error('Error initializing keys:', error);
            throw error;
        }
    }

    // Text generation
async function generateCharacterText(characterInfo) {
    if (!keysInitialized) {
        await initializeKeys();
    }

    // Map the unique Nepali races and classes to more common D&D equivalents for text generation
    // This helps the AI model understand what we're asking for
    const raceMapping = {
        'yeti': 'a powerful yeti (similar to a goliath)',
        'kinnaras': 'a musical kinnaras (similar to an elf)',
        'human': 'a human',
        'bon': 'a magical bon (similar to a tiefling)',
        'dakinis': 'a mystical dakini (similar to a celestial being)'
    };
    
    const classMapping = {
        'gurkhali': 'a martial warrior (similar to a barbarian)',
        'gandharva': 'a musical performer (similar to a bard)',
        'druid': 'a nature magic user (druid)',
        'fighter': 'a fighter',
        'monk': 'a disciplined monk',
        'paladin': 'a holy warrior (paladin)',
        'ranger': 'a wilderness expert (ranger)',
        'rogue': 'a stealthy operative (rogue)',
        'dhami': 'a deity-possessed medium (similar to a cleric)',
        'jakhris': 'a ritual shaman (similar to a warlock)',
        'wizard': 'a learned spellcaster (wizard)'
    };

    // Get the appropriate descriptions based on the character info
    const raceDescription = raceMapping[characterInfo.race] || characterInfo.race;
    const classDescription = classMapping[characterInfo.class] || characterInfo.class;

    const descriptionPrompt = `Create a character description for a D&D character with the following traits:
Race: ${raceDescription}
Class: ${classDescription}
Gender: ${characterInfo.gender}
Level: ${characterInfo.level}
Strength: ${characterInfo.strength}
Dexterity: ${characterInfo.dexterity}
Constitution: ${characterInfo.constitution}
Intelligence: ${characterInfo.intelligence}
Wisdom: ${characterInfo.wisdom}
Charisma: ${characterInfo.charisma}

Write a two paragraph description of their appearance, personality, and background.`;

    const equipmentPrompt = `List appropriate equipment for a level ${characterInfo.level} ${raceDescription} ${classDescription}.
Include weapons, armor, and adventuring gear that would make sense for their class and level.
Format as a simple list.`;

    try {
        const [descriptionResponse, equipmentResponse] = await Promise.all([
            fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${HUGGING_FACE_API_KEY}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inputs: descriptionPrompt,
                    parameters: {
                        max_new_tokens: 300,
                        temperature: 0.7,
                    }
                }),
            }),
            fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${HUGGING_FACE_API_KEY}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inputs: equipmentPrompt,
                    parameters: {
                        max_new_tokens: 200,
                        temperature: 0.7,
                    }
                }),
            })
        ]);

        const description = await descriptionResponse.json();
        const equipment = await equipmentResponse.json();

        // Extract generated text and remove the original prompt
        const extractGeneratedText = (responseText) => {
            const fullText = Array.isArray(responseText) 
                ? responseText[0].generated_text 
                : responseText.generated_text;

            // Remove the original prompt text
            const promptIndex = fullText.indexOf(descriptionPrompt);
            const equipmentPromptIndex = fullText.indexOf(equipmentPrompt);

            if (promptIndex !== -1) {
                return fullText.slice(promptIndex + descriptionPrompt.length).trim();
            } else if (equipmentPromptIndex !== -1) {
                return fullText.slice(equipmentPromptIndex + equipmentPrompt.length).trim();
            }

            return fullText.trim();
        };

        return {
            description: extractGeneratedText(description),
            equipment: extractGeneratedText(equipment)
        };
    } catch (error) {
        console.error('Error generating text:', error);
        throw new Error('Failed to generate character text. Please try again later.');
    }
}

// Progress bar utility functions
    function createProgressBar(container) {
        // Create progress bar container
        const progressContainer = document.createElement('div');
        progressContainer.className = 'progress-container';
        progressContainer.style.display = 'block';

        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';

        const progressText = document.createElement('div');
        progressText.className = 'progress-text';
        progressText.textContent = 'Generating...';

        progressContainer.appendChild(progressBar);
        progressContainer.appendChild(progressText);
        container.appendChild(progressContainer);

        return {
            progressBar,
            progressText,
            progressContainer
        };
    }

    function updateProgressBar(progressBar, percent) {
        progressBar.style.width = `${percent}%`;
    }

    function removeProgressBar(container) {
        const progressContainer = container.querySelector('.progress-container');
        if (progressContainer) {
            progressContainer.remove();
        }
    }

// Modified generateRandomCharacter to include combat stats update
async function generateRandomCharacter() {
    // Get the generate character button
    const generateBtn = document.querySelector('button[onclick="generateRandomCharacter()"]');
    const container = generateBtn.closest('.buttons');

    // Create progress bar
    const { progressBar, progressText, progressContainer } = createProgressBar(container);

    // Disable button and show progress
    generateBtn.disabled = true;
    updateProgressBar(progressBar, 20);
    progressText.textContent = 'Initializing keys...';

    try {
        if (!keysInitialized) {
            await initializeKeys();
        }
        updateProgressBar(progressBar, 40);
        progressText.textContent = 'Generating character traits...';

        // Use the actual options from the HTML select elements
        const raceSelect = document.getElementById('race');
        const classSelect = document.getElementById('class');
        const genderSelect = document.getElementById('gender');
        const weaponSelect = document.getElementById('weaponType');
        
        // Get available options from the dropdowns
        const races = Array.from(raceSelect.options).map(option => option.value);
        const classes = Array.from(classSelect.options).map(option => option.value);
        const genders = Array.from(genderSelect.options).map(option => option.value);
        const weapons = Array.from(weaponSelect.options).map(option => option.value);

        const randomRace = races[Math.floor(Math.random() * races.length)];
        const randomClass = classes[Math.floor(Math.random() * classes.length)];
        const randomGender = genders[Math.floor(Math.random() * genders.length)];
        const randomWeapon = weapons[Math.floor(Math.random() * weapons.length)];
        const level = getRandomInt(1, 5);

        // Generate ability scores
        const strength = rollAbilityScore();
        const dexterity = rollAbilityScore();
        const constitution = rollAbilityScore();
        const intelligence = rollAbilityScore();
        const wisdom = rollAbilityScore();
        const charisma = rollAbilityScore();

        updateProgressBar(progressBar, 60);
        progressText.textContent = 'Generating character description...';

        // Calculate derived stats
        const constitutionMod = getModifier(constitution);
        const dexterityMod = getModifier(dexterity);
        
        const hp = calculateHP(randomClass, level, constitutionMod);
        const ac = calculateAC(randomClass, dexterityMod);
        const initiative = dexterityMod;

        const characterInfo = {
            race: randomRace,
            class: randomClass,
            gender: randomGender,
            level: level,
            strength: strength,
            dexterity: dexterity,
            constitution: constitution,
            intelligence: intelligence,
            wisdom: wisdom,
            charisma: charisma
        };

        // Generate AI text for description and equipment
        updateProgressBar(progressBar, 80);
        progressText.textContent = 'Generating character details...';

        const generatedText = await generateCharacterText(characterInfo);
        document.getElementById('characterDescription').value = generatedText.description;
        document.getElementById('equipment').value = generatedText.equipment;

        // Update form fields - ensuring we set the values correctly
        document.getElementById('race').value = randomRace;
        document.getElementById('class').value = randomClass;
        document.getElementById('gender').value = randomGender;
        document.getElementById('level').value = level;
        document.getElementById('strength').value = strength;
        document.getElementById('dexterity').value = dexterity;
        document.getElementById('constitution').value = constitution;
        document.getElementById('intelligence').value = intelligence;
        document.getElementById('wisdom').value = wisdom;
        document.getElementById('charisma').value = charisma;
        document.getElementById('hitPoints').value = hp;
        document.getElementById('armorClass').value = ac;
        document.getElementById('initiative').value = initiative;
        document.getElementById('weaponType').value = randomWeapon;
        
        // Update combat statistics based on generated character
        updateCombatStats();

        updateProgressBar(progressBar, 100);
        progressText.textContent = 'Character generated successfully!';
    } catch (error) {
        console.error(error);
        alert(error.message);
        progressText.textContent = 'Generation failed.';
        updateProgressBar(progressBar, 0);
    } finally {
        // Re-enable button and remove progress bar after a short delay
        setTimeout(() => {
            generateBtn.disabled = false;
            removeProgressBar(container);
        }, 1500);
    }
}

    // Modify generateAIImage to include weapon in prompt
    async function generateAIImage() {
        const description = document.getElementById('characterDescription').value;
        const race = document.getElementById('race').value;
        const characterClass = document.getElementById('class').value;
        const gender = document.getElementById('gender').value;
        const weaponType = document.getElementById('weaponType').value;
        
        if (!description) {
            alert('Please add a character description first! / पहिले पात्र विवरण थप्नुहोस्!');
            return;
        }

        const container = document.getElementById('characterImageContainer');
        const generateBtn = document.querySelector('.generate-btn');

        // Create progress bar
        const { progressBar, progressText, progressContainer } = createProgressBar(container);

        // Disable button and show progress
        generateBtn.disabled = true;
        container.classList.add('loading');
        updateProgressBar(progressBar, 20);
        progressText.textContent = 'Initializing keys...';

        try {
            if (!keysInitialized) {
                await initializeKeys();
            }
            updateProgressBar(progressBar, 40);
            progressText.textContent = 'Preparing image generation...';

            // Truncate and simplify the prompt to meet API constraints
            const truncatedDescription = description.length > 500 ? description.substring(0, 500) : description;
            const prompt = `Fantasy RPG character. ${race} ${characterClass} ${gender} with ${weaponType}. ${truncatedDescription}. Detailed portrait, digital art.`;
            
            updateProgressBar(progressBar, 60);
            progressText.textContent = 'Generating image...';

            const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${STABILITY_API_KEY}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    text_prompts: [
                        {
                            text: prompt,
                            weight: 1
                        }
                    ],
                    cfg_scale: 7,
                    height: 1024,
                    width: 1024,
                    samples: 1,
                    steps: 30,
                })
            });

            updateProgressBar(progressBar, 80);
            progressText.textContent = 'Processing image...';

            if (!response.ok) {
                const responseText = await response.text();
                throw new Error(`Image generation failed: ${response.status} - ${responseText}`);
            }

            const result = await response.json();
            const imageBase64 = result.artifacts[0].base64;
            const imageUrl = `data:image/png;base64,${imageBase64}`;
            
            updateProgressBar(progressBar, 100);
            progressText.textContent = 'Image generated successfully!';
            
            container.innerHTML = `<img src="${imageUrl}" alt="Generated Character Image">`;
            localStorage.setItem('characterImage', imageUrl);
        } catch (error) {
            console.error('Error generating image:', error);
            alert(`Failed to generate image: ${error.message}`);
            progressText.textContent = 'Image generation failed.';
            updateProgressBar(progressBar, 0);
        } finally {
            // Re-enable button and remove progress bar after a short delay
            setTimeout(() => {
                container.classList.remove('loading');
                generateBtn.disabled = false;
                removeProgressBar(container);
            }, 1500);
        }
    }

    // Initialize keys when page loads and set up the combat stats
    window.onload = function() {
        initializeKeys().catch(error => {
            console.error('Failed to initialize keys:', error);
        });
        
        // Initialize combat stats on page load
        updateCombatStats();
        
        // Add event listeners to all inputs that might affect combat stats
        document.getElementById('strength').addEventListener('change', updateCombatStats);
        document.getElementById('dexterity').addEventListener('change', updateCombatStats);
        document.getElementById('constitution').addEventListener('change', updateCombatStats);
        document.getElementById('level').addEventListener('change', updateCombatStats);
        document.getElementById('weaponType').addEventListener('change', updateCombatStats);
        document.getElementById('armorClass').addEventListener('change', updateCombatStats);
    };
</script>
</body>
</html>
