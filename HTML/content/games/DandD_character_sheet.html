<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Interactive Story</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .story-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .story-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-line;
        }

        .story-image {
            width: 100%;
            max-width: 600px;
            height: 300px;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            transition: opacity 0.5s;
        }

        .input-container {
            margin-top: 20px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .history {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            color: #666;
        }

        .suggestions {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .progress-bar {
            width: 0;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            color: #666;
        }

        .fade {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="story-container">
        <h1>The AI Storyteller</h1>
        <div class="story-text" id="current-story"></div>
        
        <img src="/api/placeholder/600/300" alt="Story scene" class="story-image" id="story-image">
        
        <div class="input-container">
            <input type="text" id="user-input" placeholder="What would you like to do? (Type your action)">
            <button onclick="continueStory()" id="continue-btn">Continue Adventure</button>
        </div>
        
        <div class="history" id="story-history">
            <h3>Your Journey So Far:</h3>
        </div>
    </div>

    <script>
        // Global variables for API keys
        let HUGGING_FACE_API_KEY = null;
        let STABILITY_API_KEY = null;
        let keysInitialized = false;

        // Story state
        let storyState = {
            currentScene: '',
            history: [],
            context: [],
            currentStoryId: 0
        };

        // Story seeds
        const storySeeds = [
            "A magical library where books write themselves",
            "A city where dreams are traded like currency",
            "A forest where the trees can walk",
            "An ancient spaceship discovered in a desert",
            "A world where music creates physical objects",
            "A kingdom where shadows come alive at night",
            "A mysterious carnival that appears once every hundred years",
            "A school where students learn to time travel",
            "An island that changes location every sunrise",
            "A village where everyone can shapeshift except one person",
            "A portal hidden in an antique mirror",
            "A garden where emotions grow as flowers",
            "A lighthouse that signals to other dimensions",
            "A train that travels through memories",
            "A market where people trade years of their lives",
            "A city built inside a sleeping giant",
            "A world where colors are running out",
            "A detective agency that solves fairy tale crimes",
            "A restaurant that serves impossible dishes",
            "A museum of forgotten time periods",
            "A cloud city powered by children's laughter",
            "A library of unwritten books",
            "A town where everyone's dreams connect",
            "A circus of mechanical animals",
            "An orchestra that controls the weather",
            "A coffee shop between dimensions",
            "A post office that delivers to parallel worlds",
            "A hotel where each room is in a different era",
            "A bakery that makes prophecy cookies",
            "A painting that shows different scenes to each viewer",
            "A chess game where the pieces are alive",
            "A valley where echoes become reality",
            "A river that flows backward in time",
            "A mountain that collects lost memories",
            "A garden where statues dance at midnight",
            "A theater where the audience becomes part of the play",
            "A clock tower that controls local time",
            "A bookstore where characters escape their books",
            "A snow globe that contains a real world",
            "A map that changes based on the reader's desires",
            "A marketplace of bottled emotions",
            "A school for professional dreamers",
            "A lighthouse that guides lost souls",
            "A factory that manufactures luck",
            "A cave system that whispers secrets",
            "A bridge that connects different realities",
            "A carnival where wishes come true - with a twist",
            "A library of living memories",
            "A forest of crystal trees that sing",
            "A town where night and day are reversed",
            "A museum of impossible things",
            "A garden where time grows wild",
            "A circus that travels through dreams",
            "A valley where seasons happen simultaneously",
            "An inn between worlds",
            "A marketplace of forgotten gods",
            "A university that teaches magic through music",
            "A festival where people trade fates",
            "A city where buildings rearrange themselves nightly",
            "A train station for ghost trains",
            "A theater that shows possible futures",
            "A park where shadows tell stories",
            "A coffee shop that serves liquid memories",
            "A gallery where paintings come alive",
            "A clockmaker's shop where time is flexible",
            "A bakery that makes dreams come true",
            "A greenhouse where extinct species grow",
            "A library where books choose their readers",
            "A tavern where adventurers' tales become real",
            "A mirror maze that shows alternate lives",
            "A garden where wishes grow like plants",
            "A school where children learn to fly",
            "A temple where prayers manifest physically",
            "A market where memories are bought and sold",
            "A workshop that repairs broken dreams",
            "A sanctuary for retired magic items",
            "A laboratory where emotions are studied",
            "A observatory that looks into other worlds",
            "A archive of forgotten languages",
            "A hospital for magical ailments",
            "A bank that stores secrets instead of money",
            "A post office for interdimensional mail",
            "A cafe where time stops while you drink",
            "A theater where stories write themselves",
            "A museum of prophetic artifacts",
            "A garden where moonlight blooms",
            "A library of future histories",
            "A school for time travelers",
            "A marketplace of bottled starlight",
            "A sanctuary for retired heroes",
            "A workshop where dreams are repaired",
            "A gallery of living paintings",
            "A tower where wind spirits dwell",
            "A cafe that serves happiness",
            "A circus of impossible acts",
            "A bookstore of unwritten stories",
            "A garden where seasons sleep",
            "A theater of shadow players",
            "A factory of childhood memories",
            "A library where silence speaks",
            "A market of traded destinies",
            "A school for ghost hunters",
            "A museum of lost time"
        ];

        // Initialize API keys
        async function initializeKeys() {
            if (keysInitialized) return;
            
            try {
                const response = await fetch('https://zuqaonnjhyobeljlum4m6gclae0gdxsp.lambda-url.us-west-2.on.aws/', {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const keys = await response.json();
                if (!keys.huggingFaceKey || !keys.stabilityKey) {
                    throw new Error('Invalid API key data received');
                }
                
                HUGGING_FACE_API_KEY = keys.huggingFaceKey;
                STABILITY_API_KEY = keys.stabilityKey;
                keysInitialized = true;
                console.log('API keys initialized successfully');
                
                // Start the story once keys are initialized
                startStory();
            } catch (error) {
                console.error('Error initializing keys:', error);
                throw error;
            }
        }

        // Progress bar utility functions
        function createProgressBar(container) {
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.style.display = 'block';

            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';

            const progressText = document.createElement('div');
            progressText.className = 'progress-text';
            progressText.textContent = 'Generating...';

            progressContainer.appendChild(progressBar);
            progressContainer.appendChild(progressText);
            container.appendChild(progressContainer);

            return {
                progressBar,
                progressText,
                progressContainer
            };
        }

        function updateProgressBar(progressBar, percent) {
            progressBar.style.width = `${percent}%`;
        }

        function removeProgressBar(container) {
            const progressContainer = container.querySelector('.progress-container');
            if (progressContainer) {
                progressContainer.remove();
            }
        }

        // Generate story text using Hugging Face
        async function generateStoryText(prompt) {
            const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${HUGGING_FACE_API_KEY}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inputs: prompt,
                    parameters: {
                        max_new_tokens: 150,
                        min_new_tokens: 50,
                        temperature: 0.7,
                        top_p: 0.9,
                        repetition_penalty: 1.1
                    }
                }),
            });

            const result = await response.json();
            const generatedText = Array.isArray(result) ? result[0].generated_text : result.generated_text;
            
            // Clean up the output by removing prompts
            let cleanText = generatedText;
            
            // Remove the initial storyteller prompts with story seeds
            const storytellerPrompts = [
                "You are a creative storyteller. Using this story concept as inspiration:",
                "You are a creative storyteller. Write the beginning",
                "You are continuing a story based on the concept:"
            ];
            
            for (const prompt of storytellerPrompts) {
                if (cleanText.includes(prompt)) {
                    const startIndex = cleanText.indexOf(prompt);
                    // Find the next quote after the prompt that contains the story seed
                    const quoteIndex = cleanText.indexOf('"', startIndex);
                    if (quoteIndex !== -1) {
                        const endQuoteIndex = cleanText.indexOf('"', quoteIndex + 1);
                        if (endQuoteIndex !== -1) {
                            // Skip past the ending instructions part as well
                            const endInstructionIndex = cleanText.indexOf("words.", endQuoteIndex);
                            if (endInstructionIndex !== -1) {
                                cleanText = cleanText.substring(endInstructionIndex + 6).trim();
                            } else {
                                cleanText = cleanText.substring(endQuoteIndex + 1).trim();
                            }
                        }
                    }
                }
            }
            
            // Remove any "Based on this story context" prompts
            const contextPromptStart = "Based on this story context:";
            while (cleanText.includes(contextPromptStart)) {
                const startIndex = cleanText.indexOf(contextPromptStart);
                const nextQuoteIndex = cleanText.indexOf('"', startIndex + contextPromptStart.length + 2); // +2 for the quote and space
                if (nextQuoteIndex !== -1) {
                    const endQuoteIndex = cleanText.indexOf('"', nextQuoteIndex + 1);
                    if (endQuoteIndex !== -1) {
                        // Remove the prompt and the quoted context
                        cleanText = cleanText.substring(endQuoteIndex + 1).trim();
                    } else {
                        break;
                    }
                } else {
                    break;
                }
            }
            
            // Remove "The reader chooses to:" prompts
            const choicePromptStart = "The reader chooses to:";
            while (cleanText.includes(choicePromptStart)) {
                const startIndex = cleanText.indexOf(choicePromptStart);
                const nextQuoteIndex = cleanText.indexOf('"', startIndex + choicePromptStart.length + 1);
                if (nextQuoteIndex !== -1) {
                    const endQuoteIndex = cleanText.indexOf('"', nextQuoteIndex + 1);
                    if (endQuoteIndex !== -1) {
                        // Remove the prompt and the quoted choice
                        cleanText = cleanText.substring(endQuoteIndex + 1).trim();
                    } else {
                        break;
                    }
                } else {
                    break;
                }
            }
            
            // Remove any "Continue the story" instructions
            const continuePrompts = [
                "Continue the story by describing what happens next. End with a new choice for the reader. Keep it under 200 words.",
                "Continue the story by describing what happens next. Focus on atmosphere and vivid details. End with 2-3 new choices for the reader. Keep it under 200 words."
            ];
            
            for (const prompt of continuePrompts) {
                if (cleanText.includes(prompt)) {
                    cleanText = cleanText.substring(cleanText.indexOf(prompt) + prompt.length).trim();
                }
            }
            
            // Remove any remaining instances of "You are continuing a story" prefixes
            const continuingPrefix = "You are continuing a story";
            if (cleanText.includes(continuingPrefix)) {
                const startIndex = cleanText.indexOf(continuingPrefix);
                const endIndex = cleanText.indexOf('"', startIndex);
                if (endIndex !== -1) {
                    const nextQuoteIndex = cleanText.indexOf('"', endIndex + 1);
                    if (nextQuoteIndex !== -1) {
                        cleanText = cleanText.substring(nextQuoteIndex + 1).trim();
                    }
                }
            }
            
            return cleanText;
        }

        // Generate image using Stability AI
        async function generateImage(prompt) {
            const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${STABILITY_API_KEY}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    text_prompts: [
                        {
                            text: prompt,
                            weight: 1
                        }
                    ],
                    cfg_scale: 7,
                    height: 1024,
                    width: 1024,
                    samples: 1,
                    steps: 30,
                })
            });

            if (!response.ok) {
                throw new Error(`Image generation failed: ${response.status}`);
            }

            const result = await response.json();
            return `data:image/png;base64,${result.artifacts[0].base64}`;
        }

        // Start the story
        async function startStory() {
            const container = document.querySelector('.story-container');
            const { progressBar, progressText } = createProgressBar(container);
            
            try {
                updateProgressBar(progressBar, 30);
                progressText.textContent = 'Generating initial story...';

                // Get a random story seed
                storyState.currentStoryId = Math.floor(Math.random() * storySeeds.length);
                const storySeed = storySeeds[storyState.currentStoryId];

                const initialPrompt = `Below is a story concept. Create a very short fantasy scene (60 words) with two choices at the end.

Concept: "${storySeed}"

Requirements:
- Write a complete scene with beginning and choices in 60 words
- Add "Choice A:" and "Choice B:" at the end
- Each choice should be under 10 words
- Write only the story and choices, nothing else

Response:`;
                const storyText = await generateStoryText(initialPrompt);
                
                updateProgressBar(progressBar, 60);
                progressText.textContent = 'Generating scene image...';

                const imagePrompt = `Fantasy scene, digital art style: ${storyText.slice(0, 200)}`;
                const imageUrl = await generateImage(imagePrompt);

                updateProgressBar(progressBar, 100);
                progressText.textContent = 'Story ready!';

                document.getElementById('current-story').textContent = storyText;
                document.getElementById('story-image').src = imageUrl;

                storyState.currentScene = storyText;
                storyState.context.push(storyText);
            } catch (error) {
                console.error('Error starting story:', error);
                document.getElementById('current-story').textContent = 'Error starting story. Please refresh the page to try again.';
            } finally {
                removeProgressBar(container);
            }
        }

        // Continue the story based on user input
        async function continueStory() {
            const userInput = document.getElementById('user-input').value;
            if (!userInput) return;

            const container = document.querySelector('.story-container');
            const continueBtn = document.getElementById('continue-btn');
            const { progressBar, progressText } = createProgressBar(container);

            // Disable button and show loading state
            continueBtn.disabled = true;
            document.getElementById('current-story').classList.add('fade');
            document.getElementById('story-image').classList.add('fade');

            try {
                updateProgressBar(progressBar, 30);
                progressText.textContent = 'Processing your choice...';

                // Save current story to history
                storyState.history.push({
                    scene: storyState.currentScene,
                    action: userInput
                });

                // Get the current story seed
                const storySeed = storySeeds[storyState.currentStoryId];

                // Generate new story segment
                const prompt = `Continue this fantasy scene in 60 words with two short choices.

Previous: "${storyState.currentScene}"
Action: "${userInput}"

Requirements:
- Write a complete scene with beginning and choices in 60 words
- Add "Choice A:" and "Choice B:" at the end
- Each choice should be under 10 words
- Write only the story and choices, nothing else

Response:`;



                const newStoryText = await generateStoryText(prompt);
                
                updateProgressBar(progressBar, 60);
                progressText.textContent = 'Generating new scene image...';

                // Generate new image
                const imagePrompt = `Fantasy scene, digital art style: ${newStoryText.slice(0, 200)}`;
                const imageUrl = await generateImage(imagePrompt);

                updateProgressBar(progressBar, 100);
                progressText.textContent = 'Scene ready!';

                // Update the story display
                document.getElementById('current-story').textContent = newStoryText;
                document.getElementById('story-image').src = imageUrl;
                document.getElementById('user-input').value = '';

                // Update story state
                storyState.currentScene = newStoryText;
                storyState.context.push(newStoryText);

                // Update history display
                updateHistory();
            } catch (error) {
                console.error('Error continuing story:', error);
                alert('Error generating story continuation. Please try again.');
            } finally {
                // Re-enable button and remove loading state
                continueBtn.disabled = false;
                document.getElementById('current-story').classList.remove('fade');
                document.getElementById('story-image').classList.remove('fade');
                removeProgressBar(container);
            }
        }

        // Update history display
        function updateHistory() {
            const historyDiv = document.getElementById('story-history');
            let historyHTML = '<h3>Your Journey So Far:</h3>';
            storyState.history.forEach((segment, index) => {
                historyHTML += `<p><strong>Choice ${index + 1}:</strong> You chose to ${segment.action}</p>`;
            });
            historyDiv.innerHTML = historyHTML;
        }

        // Allow Enter key to submit
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                continueStory();
            }
        });

        // Initialize when page loads
        window.onload = function() {
            initializeKeys().catch(error => {
                console.error('Failed to initialize:', error);
                document.getElementById('current-story').textContent = 'Error initializing story. Please refresh the page to try again.';
            });
        };
    </script>
</body>
</html>