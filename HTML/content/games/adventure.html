<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Story</title>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        .story-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .story-content {
            white-space: pre-wrap;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .button {
            background-color: #3498db;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 8px;
        }

        .error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .input-container {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
    function Adventure() {
        const [story, setStory] = React.useState('');
        const [input, setInput] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [image, setImage] = React.useState(null);
        const [previousText, setPreviousText] = React.useState('');
        const [translatedText, setTranslatedText] = React.useState('');
        const [translating, setTranslating] = React.useState(false);
        const [storyType, setStoryType] = React.useState('fantasy');
        const sessionId = React.useMemo(() => `session-${Date.now()}`, []);
        const STORY_LAMBDA_URL = 'https://hutcbbitwm5yzzth6lgbeamzuq0eaxjj.lambda-url.us-west-2.on.aws/';
        const TRANSLATE_LAMBDA_URL = 'https://6wc27t43ltvln6pm3k3yuu6ooi0heoxz.lambda-url.us-west-2.on.aws/';

        React.useEffect(() => {
            startNewStory();
        }, []);

        async function startNewStory() {
            try {
                const data = await makeRequest({
                    action: 'start_new',
                    session_id: sessionId,
                    story_type: storyType
                });

                if (data?.response) {
                    const newText = data.response.text || '';
                    setStory(newText);
                    setPreviousText(newText);
                    setTranslatedText('');
                    if (data.response.image) {
                        setImage(data.response.image);
                    }
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Start story error:', error);
                setError(error.message || 'Failed to start story');
            }
        }

        async function continueStory(userInput) {
            try {
                const data = await makeRequest({
                    action: 'continue',
                    session_id: sessionId,
                    input: userInput,
                    story_type: storyType
                });

                if (data?.response) {
                    const newText = data.response.text || '';
                    setStory(prev => `${prev}\n\nYou: ${userInput}\n\n${newText}`);
                    setPreviousText(newText);
                    setTranslatedText('');
                    if (data.response.image) {
                        setImage(data.response.image);
                    }
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Continue story error:', error);
                setError(error.message || 'Failed to continue story');
            }
        }

        async function translateLastOutput() {
            if (!previousText || translating) return;
            
            setTranslating(true);
            setError(null);
            
            try {
                await fetch(TRANSLATE_LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: previousText,
                        operation: 'translate'
                    })
                }).then(async (response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.result) {
                        setTranslatedText(data.result);
                    }
                });
            } catch (error) {
                console.error('Translation error:', error);
                setError('Failed to translate text');
            } finally {
                setTranslating(false);
            }
        }

        async function makeRequest(payload) {
            setLoading(true);
            setError(null);

            try {
                console.log('Sending payload:', payload);
                
                const response = await fetch(STORY_LAMBDA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                if (!responseText) {
                    throw new Error('Empty response from server');
                }

                const data = JSON.parse(responseText);
                console.log('Parsed response:', data);
                return data;
            } catch (error) {
                console.error('Request error:', error);
                throw error;
            } finally {
                setLoading(false);
            }
        }

        function handleSubmit(e) {
            e.preventDefault();
            if (!input.trim() || loading) return;

            continueStory(input);
            setInput('');
        }

        return (
            <div className="story-container">
                <h1 className="title">Fantasy Story Generator</h1>
                
                {error && (
                    <div className="error">
                        {error}
                    </div>
                )}

                {image && (
                    <div className="image-container" style={{ marginBottom: '1rem' }}>
                        <img 
                            src={image} 
                            alt="Story scene" 
                            style={{ 
                                width: '100%',
                                maxHeight: '400px',
                                objectFit: 'contain',
                                borderRadius: '0.5rem',
                                boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                            }} 
                        />
                    </div>
                )}

                <div className="story-content">
                    {story || (loading ? "Loading your story..." : "Your story begins here...")}
                </div>

                {translatedText && (
                    <div className="story-content" style={{ 
                        marginTop: '1rem',
                        padding: '1rem',
                        backgroundColor: '#f8f9fa',
                        borderRadius: '0.5rem',
                        borderLeft: '4px solid #3498db'
                    }}>
                        {translatedText}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="input-container">
                    <input
                        type="text"
                        className="input"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="What would you like to do?"
                        disabled={loading}
                    />
                    <button 
                        type="submit" 
                        className="button"
                        disabled={loading || !input.trim()}
                    >
                        {loading ? "Thinking..." : "Submit"}
                    </button>
                </form>

                <div className="input-container" style={{ gap: '1rem' }}>
                    <button 
                        onClick={startNewStory}
                        className="button"
                        disabled={loading}
                        style={{flex: 1}}
                    >
                        Start New Story
                    </button>
                    <button 
                        onClick={translateLastOutput}
                        className="button"
                        disabled={translating || !previousText || loading}
                        style={{
                            flex: 1,
                            backgroundColor: '#2ecc71'
                        }}
                    >
                        {translating ? "Translating..." : "Translate to Nepali"}
                    </button>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
        <React.StrictMode>
            <Adventure />
        </React.StrictMode>
    );
</script>
</body>
</html>